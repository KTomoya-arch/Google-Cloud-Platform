# Kubernetes とは？

オーケストラの指揮者のような存在であり、複数のコンテナを管理するもの。
Kubernetes は複数の物理的 or 仮想的なマシンがあることが前提であり、そのマシンそれぞれの中に複数のコンテナが存在する。

## ざっくりとした構成

マスターノード(コントロールを司るノード)とワーカーノード(実際に動かす)で構成されている。
ノードがわからない場合は一旦物理マシンと読み替えてみるのが良いかもしれない。

### マスターノードとワーカーノードの違いは？

マスターノードは現場監督/管理職みたいなものであり、マスターノード上でコンテナは動いていない。
ワーカーノード(実際のサーバーに当たる部分)上のコンテナをマスターノードが管理している。
コンテナランタイムはワーカーノード上にある。
上記のマスターノードとワーカーノードで構成された Kubernetes システムの一群のことをクラスターと呼ぶ。

## Kubernetes を使用する

マスターノードにはコンテナの状態管理のために etcd というデータベースを入れ、ワーカーノードには Container Engine を入れる。
マスターノードの設定を行うのは管理者である人間でその管理者が使用する PC には`kubectl`をインストールする必要がある。
`kubectl`を使用すると、マスターノードへログインし、初期設定を行なったり・調整することができるようになる。

## コントロールプレーンと kubelet

マスターノードではコントロールプレーン(制御盤)でワーカーノードを管理する。
コントロールプレーンは以下の５つのコンポーネントで構成される。

`マスターノードの構成`

- kube-apiserver
  外部とやり取りを行うプロセスであり、kubectl からの命令を受け取り実行する。
- kube-controller-manager
  一番の心臓部分。
- kube-scheduler
  pod をワーカーノードへ割り当てる。
- cloud-controller-manager
  クラウドサービスと連携。
- etcd
  `etcd`以外は Kubernetes に入っており、追加で何かを入れる必要は基本的にない。

`ワーカーノードの構成`

- kube-let
  マスターノード側の kube-scheduler と連携し、ワーカーノード上に Pod を配置する。
- kube-proxy
  ネットワーク通信をルーティングする。

## Kubernetes は常に望ましい状態に保つ

Kubernetes はコンテナを削除したり作成することも可能だが一つ一つコマンドを入力してそのようなことをすることはない。
理想のコンテナ数・ボリュームの数などを構成ファイル(YAML)で定義しその通りに自動でコンテナの作成・削除を実施する。
`docker-compose`では作成時はコンテナに寄与するが、kubernetes ではその状態の維持を行う。

## Kubernetes を構成するその他のもの(ワーカーノードとかマスターノード以外のこと)

### Pod

Kubernetes ではコンテナは Pod で管理される。
Pod はコンテナとボリュームがセットになったものである。
基本的に 1Pod は１コンテナであるがコンテナを複数にすることもできる。
ボリュームは Pod の中にある`複数のコンテナ`が情報共有するために使用するもの。
ここでいう複数のコンテナというのは、WordPress と MySQL のような関係性の２つのコンテナではなく、
メインのプログラムとメインのプログラムからの出力を深夜に集計処理するプログラムのような連携するプログラムの関係を指す。
ボリュームを作らない場合もあるが、Pod にせずにコンテナのままでよくね？と思うがコンテナの管理は Pod 単位で行うため、コンテナが１つだけしか入っていなくとも Pod として扱う。

### Service

Cluster IP は Service ごとにふられる。
Pod をまとめて管理するものをサービス(Service)という。この場合のサービスは Pod を管理する班長みたいなイメージ。
１つのサービスが管理する Pod は同一構成の Pod である。違う構成の Pod は別のサービスが管理する。
Pod へのアクセスを管理するロードバランサー的な役割もある。

## レプリカセット(ReplicaSet)

Service は通信を裁くロードバランサー的な役割だとしたら、レプリカセットは Pod の数を管理する。
Pod が停止した場合には足りない分を増やしたり、定義ファイルの Pod 数が減ればその分を減らす。
レプリカセットにより構成されている同一構成の Pod をレプリカという。

## デプロイメント(Deployment)

レプリカセットを使用する場合はこのデプロイメントも使用する。
デプロイメントは Pod のデプロイを管理する。
Pod がどのイメージを使用するかなどの Pod に関する情報を持っている。
